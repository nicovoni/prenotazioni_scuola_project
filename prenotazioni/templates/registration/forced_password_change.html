{% extends "base.html" %}
{% block title %}Cambia password obbligatoria{% endblock %}
{% block content %}
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0">üîê Cambio Password Obbligatorio</h3>
          </div>
          <div class="card-body">
            <p class="text-muted"><strong>Per motivi di sicurezza</strong>, devi aggiornare la password dell'account amministratore prima di continuare.</p>
            <p class="small text-muted">Crea una password <strong>forte e unica</strong> seguendo i requisiti sottostanti. Puoi generare una password suggerita premendo il pulsante <strong>üîÄ</strong>.</p>
            
            <form method="post" id="passwordForm" data-check-url="{% url 'prenotazioni:check_password_strength' %}" data-generate-url="{% url 'prenotazioni:generate_password' %}">
              {% csrf_token %}
              
              <!-- Campo password attuale -->
              <div class="mb-3">
                <label for="id_old_password" class="form-label">
                  <strong>Password Attuale</strong>
                </label>
                <input type="password" name="old_password" id="id_old_password" class="form-control" required>
                {% if form.old_password.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.old_password.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Campo nuova password con validatore -->
              <div class="mb-4">
                <label for="id_new_password1" class="form-label">
                  <strong>Nuova Password</strong>
                </label>
                <div class="input-group">
                  <input type="password" name="new_password1" id="id_new_password1" class="form-control" required aria-describedby="strength-text requirements-list" aria-invalid="false">
                  <button class="btn btn-outline-secondary" type="button" id="toggleShowPw" title="Mostra/Nascondi password" aria-label="Mostra o nascondi la password in chiaro">üëÅÔ∏è</button>
                  <button class="btn btn-outline-secondary" type="button" id="generatePw" title="Genera una password sicura casuale" aria-label="Genera una password sicura suggerita">üîÄ Genera</button>
                  <button class="btn btn-outline-secondary" type="button" id="copyPw" title="Copia password negli appunti" aria-label="Copia la password negli appunti" style="display:none;">üìã Copia</button>
                </div>
                {% if form.new_password1.errors %}
                  <div class="text-danger small mt-2">
                    {% for error in form.new_password1.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Requisiti della password -->
                  <div class="mt-3 p-3 bg-light border rounded" id="requirements-list" aria-live="polite">
                  <h6 class="mb-3">üìã Requisiti della Password:</h6>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_uppercase">‚óã</span>
                    <span>Almeno una <strong>lettera maiuscola</strong> (A-Z)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_lowercase">‚óã</span>
                    <span>Almeno una <strong>lettera minuscola</strong> (a-z)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_digit">‚óã</span>
                    <span>Almeno una <strong>cifra</strong> (0-9)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_special">‚óã</span>
                    <span>Almeno un <strong>carattere speciale</strong> (!@#$%^&*-_=+)</span>
                  </div>
                  
                  <hr class="my-2">
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length8">‚óã</span>
                    <span>Almeno <strong>8 caratteri</strong></span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length10">‚óã</span>
                    <span>Almeno <strong>10 caratteri</strong> (consigliato)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length12">‚óã</span>
                    <span>Almeno <strong>12 caratteri</strong> (ottimale)</span>
                  </div>

                  <hr class="my-2">
                  
                  <div id="strength-indicator" class="alert alert-info mb-0" role="status" aria-live="polite">
                    <div class="d-flex justify-content-between align-items-center">
                      <strong class="me-2">üí™ Forza della password:</strong>
                      <small id="strength-text">Inserisci una password</small>
                    </div>

                    <div class="progress mt-2" style="height:10px;">
                      <div id="strength-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Campo conferma password -->
              <div class="mb-3">
                <label for="id_new_password2" class="form-label">
                  <strong>Conferma Nuova Password</strong>
                </label>
                <input type="password" name="new_password2" id="id_new_password2" class="form-control" required aria-describedby="password-match-status">
                <small id="password-match-status" class="d-block mt-2" style="display: none;"></small>
                {% if form.new_password2.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.new_password2.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Bottone submit -->
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                  ‚úì Aggiorna Password
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .requirement-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 0.95rem;
    }
    
    .requirement-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      margin-right: 0.75rem;
      font-weight: bold;
      font-size: 1.2rem;
      background-color: #e0e0e0;
      color: #666;
      min-width: 28px;
    }
    
    .requirement-icon.satisfied {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }
    
    .requirement-icon.satisfied::after {
      content: "‚úì";
      position: absolute;
    }
    
    .requirement-item.satisfied {
      color: #28a745;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('id_new_password1');
      const confirmInput = document.getElementById('id_new_password2');
      const submitBtn = document.getElementById('submitBtn');
      const strengthIndicator = document.getElementById('strength-indicator');
      const strengthText = document.getElementById('strength-text');
      const strengthBar = document.getElementById('strength-bar');
      const toggleShowPw = document.getElementById('toggleShowPw');
      const generatePw = document.getElementById('generatePw');
      const copyPw = document.getElementById('copyPw');
      const passwordMatchStatus = document.getElementById('password-match-status');
      
      // CSRF token per AJAX: prefer token nel form, fallback al cookie
      function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? v.pop() : '';
      }

      let csrfToken = '';
      try {
        const t = document.querySelector('[name=csrfmiddlewaretoken]');
        csrfToken = t ? t.value : '';
      } catch(e) { csrfToken = ''; }
      if (!csrfToken) csrfToken = getCookie('csrftoken');
      
      // Mapping tra ID requisito e classe/testo
      const requirementIds = {
        'has_uppercase': 'icon_uppercase',
        'has_lowercase': 'icon_lowercase',
        'has_digit': 'icon_digit',
        'has_special': 'icon_special',
        'min_length_8': 'icon_length8',
        'min_length_10': 'icon_length10',
        'min_length_12': 'icon_length12',
      };
      
      // Debounce helper per ridurre le chiamate AJAX
      function debounce(fn, delay) {
        let t = null;
        return function(...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      // Valida corrispondenza password in tempo reale
      function validatePasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (!password) {
          passwordMatchStatus.style.display = 'none';
          return;
        }
        
        if (!confirm) {
          passwordMatchStatus.style.display = 'none';
          return;
        }
        
        passwordMatchStatus.style.display = 'block';
        if (password === confirm) {
          passwordMatchStatus.innerHTML = '<span class="text-success">‚úì Le password corrispondono</span>';
          passwordMatchStatus.className = 'd-block mt-2 text-success';
        } else {
          passwordMatchStatus.innerHTML = '<span class="text-danger">‚úï Le password non corrispondono</span>';
          passwordMatchStatus.className = 'd-block mt-2 text-danger';
        }
      }

      function updatePasswordStrength() {
        const password = passwordInput.value;

        if (!password) {
          // Reset tutti gli indicatori
          Object.values(requirementIds).forEach(iconId => {
            const icon = document.getElementById(iconId);
            if (icon) {
              icon.textContent = '‚óã';
              icon.classList.remove('satisfied');
              icon.parentElement.classList.remove('satisfied');
            }
          });
          strengthText.textContent = 'Inserisci una password';
          strengthIndicator.className = 'alert alert-info mb-0';
          strengthBar.style.width = '0%';
          submitBtn.disabled = true;
          copyPw.style.display = 'none';
          return;
        }

        // Mostra il bottone copia quando c'√® una password
        copyPw.style.display = 'inline-block';

        // Chiama l'endpoint AJAX per validare (debounced)
        const checkUrl = (function(){
          try { return document.getElementById('passwordForm').dataset.checkUrl; } catch(e) { return null; }
        })() || '{% url "prenotazioni:check_password_strength" %}';

        fetch(checkUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: 'password=' + encodeURIComponent(password)
        })
        .then(response => response.json())
        .then(data => {
          const requirements = data.requirements;
          const isStrong = data.is_strong;

          // Aggiorna gli indicatori visivi
          Object.entries(requirementIds).forEach(([reqKey, iconId]) => {
            const icon = document.getElementById(iconId);
            if (icon) {
              if (requirements[reqKey]) {
                icon.textContent = '‚úì';
                icon.classList.add('satisfied');
                icon.parentElement.classList.add('satisfied');
              } else {
                icon.textContent = '‚úï';
                icon.classList.remove('satisfied');
                icon.parentElement.classList.remove('satisfied');
              }
            }
          });

          // Aggiorna barra di progresso (basata sul numero di requisiti soddisfatti)
          const totalReq = Object.keys(requirements).length;
          const satisfiedCount = Object.values(requirements).filter(v => v).length;
          const percent = Math.round((satisfiedCount / totalReq) * 100);
          strengthBar.style.width = percent + '%';

          // Aggiorna l'indicatore di forza
          if (isStrong) {
            strengthText.textContent = '‚úì Password Forte!';
            strengthIndicator.className = 'alert alert-success mb-0';
            submitBtn.disabled = false;
          } else {
            strengthText.textContent = `Requisiti soddisfatti: ${satisfiedCount}/${totalReq}`;
            strengthIndicator.className = 'alert alert-warning mb-0';
            submitBtn.disabled = true;
          }
        })
        .catch(error => {
          console.error('Errore durante il controllo della password:', error);
        });
      }
      
      // Controlla la password mentre l'utente digita (debounced)
      const debouncedUpdate = debounce(updatePasswordStrength, 250);
      passwordInput.addEventListener('input', function() {
        debouncedUpdate();
        validatePasswordMatch();
      });
      passwordInput.addEventListener('change', debouncedUpdate);
      
      // Valida corrispondenza quando conferma cambia
      confirmInput.addEventListener('input', validatePasswordMatch);
      confirmInput.addEventListener('change', validatePasswordMatch);

      // Toggle mostra/nascondi password
      toggleShowPw.addEventListener('click', function() {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        confirmInput.type = type;
        toggleShowPw.textContent = type === 'text' ? 'üôà' : 'üëÅÔ∏è';
      });

      // Copia password negli appunti
      copyPw.addEventListener('click', function() {
        const password = passwordInput.value;
        if (!password) return;
        
        navigator.clipboard.writeText(password).then(() => {
          const originalText = copyPw.textContent;
          copyPw.textContent = '‚úì Copiato!';
          setTimeout(() => {
            copyPw.textContent = originalText;
          }, 2000);
        }).catch(err => {
          alert('Errore durante la copia negli appunti');
          console.error('Clipboard error:', err);
        });
      });

      // Genera password: preferisci endpoint server-side, fallback client-side
      generatePw.addEventListener('click', function() {
        const generateUrl = (function(){ try { return document.getElementById('passwordForm').dataset.generateUrl; } catch(e){ return null; } })();
        if (generateUrl) {
          fetch(generateUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrfToken
            },
            body: ''
          })
          .then(r => r.json())
          .then(data => {
            if (data && data.password) {
              passwordInput.value = data.password;
              confirmInput.value = data.password;
              updatePasswordStrength();
              validatePasswordMatch();
            } else {
              // fallback client-side
              clientGenerate();
            }
          })
          .catch(err => {
            console.warn('Server generate failed, falling back to client:', err);
            clientGenerate();
          });
        } else {
          clientGenerate();
        }
      });

      function clientGenerate() {
        const generated = (function(len=16){
          const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()-_=+[]{};:,.<>?/\\|`~';
          const arr = new Uint32Array(len);
          window.crypto.getRandomValues(arr);
          return Array.from(arr).map((v,i)=>chars[v % chars.length]).join('');
        })(16);
        passwordInput.value = generated;
        confirmInput.value = generated;
        updatePasswordStrength();
        validatePasswordMatch();
      }
      
      // Validazione al submit
      document.getElementById('passwordForm').addEventListener('submit', function(e) {
        const password = passwordInput.value;
        if (!password) {
          e.preventDefault();
          alert('Inserisci una password');
          return false;
        }
      });
    });
  </script>
{% endblock %}
