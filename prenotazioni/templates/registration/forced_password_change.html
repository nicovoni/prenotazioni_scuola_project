{% extends "base.html" %}
{% block title %}Cambia password obbligatoria{% endblock %}
{% block content %}
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0">üîê Cambio Password Obbligatorio</h3>
          </div>
          <div class="card-body">
            <p class="text-muted">Per motivi di sicurezza devi aggiornare la password dell'account amministratore prima di continuare.</p>
            
            <form method="post" id="passwordForm">
              {% csrf_token %}
              
              <!-- Campo password attuale -->
              <div class="mb-3">
                <label for="id_old_password" class="form-label">
                  <strong>Password Attuale</strong>
                </label>
                <input type="password" name="old_password" id="id_old_password" class="form-control" required>
                {% if form.old_password.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.old_password.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Campo nuova password con validatore -->
              <div class="mb-4">
                <label for="id_new_password1" class="form-label">
                  <strong>Nuova Password</strong>
                </label>
                <input type="password" name="new_password1" id="id_new_password1" class="form-control" required>
                {% if form.new_password1.errors %}
                  <div class="text-danger small mt-2">
                    {% for error in form.new_password1.errors %}
                      <div>{{ error }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Requisiti della password -->
                <div class="mt-3 p-3 bg-light border rounded">
                  <h6 class="mb-3">üìã Requisiti della Password:</h6>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_uppercase">‚óã</span>
                    <span>Almeno una <strong>lettera maiuscola</strong> (A-Z)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_lowercase">‚óã</span>
                    <span>Almeno una <strong>lettera minuscola</strong> (a-z)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_digit">‚óã</span>
                    <span>Almeno una <strong>cifra</strong> (0-9)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_special">‚óã</span>
                    <span>Almeno un <strong>carattere speciale</strong> (!@#$%^&*-_=+)</span>
                  </div>
                  
                  <hr class="my-2">
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length8">‚óã</span>
                    <span>Almeno <strong>8 caratteri</strong></span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length10">‚óã</span>
                    <span>Almeno <strong>10 caratteri</strong> (consigliato)</span>
                  </div>
                  
                  <div class="requirement-item">
                    <span class="requirement-icon" id="icon_length12">‚óã</span>
                    <span>Almeno <strong>12 caratteri</strong> (ottimale)</span>
                  </div>

                  <hr class="my-2">
                  
                  <div id="strength-indicator" class="alert alert-info mb-0">
                    <strong>üí™ Forza della password:</strong> <span id="strength-text">Inserisci una password</span>
                  </div>
                </div>
              </div>

              <!-- Campo conferma password -->
              <div class="mb-3">
                <label for="id_new_password2" class="form-label">
                  <strong>Conferma Nuova Password</strong>
                </label>
                <input type="password" name="new_password2" id="id_new_password2" class="form-control" required>
                {% if form.new_password2.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.new_password2.errors.0 }}
                  </div>
                {% endif %}
              </div>

              <!-- Bottone submit -->
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                  ‚úì Aggiorna Password
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .requirement-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      font-size: 0.95rem;
    }
    
    .requirement-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      margin-right: 0.75rem;
      font-weight: bold;
      font-size: 1.2rem;
      background-color: #e0e0e0;
      color: #666;
      min-width: 28px;
    }
    
    .requirement-icon.satisfied {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }
    
    .requirement-icon.satisfied::after {
      content: "‚úì";
      position: absolute;
    }
    
    .requirement-item.satisfied {
      color: #28a745;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('id_new_password1');
      const submitBtn = document.getElementById('submitBtn');
      const strengthIndicator = document.getElementById('strength-indicator');
      const strengthText = document.getElementById('strength-text');
      
      // CSRF token per AJAX
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      // Mapping tra ID requisito e classe/testo
      const requirementIds = {
        'has_uppercase': 'icon_uppercase',
        'has_lowercase': 'icon_lowercase',
        'has_digit': 'icon_digit',
        'has_special': 'icon_special',
        'min_length_8': 'icon_length8',
        'min_length_10': 'icon_length10',
        'min_length_12': 'icon_length12',
      };
      
      function updatePasswordStrength() {
        const password = passwordInput.value;
        
        if (!password) {
          // Reset tutti gli indicatori
          Object.values(requirementIds).forEach(iconId => {
            const icon = document.getElementById(iconId);
            if (icon) {
              icon.textContent = '‚óã';
              icon.classList.remove('satisfied');
              icon.parentElement.classList.remove('satisfied');
            }
          });
          strengthText.textContent = 'Inserisci una password';
          strengthIndicator.className = 'alert alert-info mb-0';
          submitBtn.disabled = false;
          return;
        }
        
        // Chiama l'endpoint AJAX per validare
        fetch('{% url "prenotazioni:check_password_strength" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: 'password=' + encodeURIComponent(password)
        })
        .then(response => response.json())
        .then(data => {
          const requirements = data.requirements;
          const isStrong = data.is_strong;
          
          // Aggiorna gli indicatori visivi
          Object.entries(requirementIds).forEach(([reqKey, iconId]) => {
            const icon = document.getElementById(iconId);
            if (icon) {
              if (requirements[reqKey]) {
                icon.textContent = '‚úì';
                icon.classList.add('satisfied');
                icon.parentElement.classList.add('satisfied');
              } else {
                icon.textContent = '‚óã';
                icon.classList.remove('satisfied');
                icon.parentElement.classList.remove('satisfied');
              }
            }
          });
          
          // Aggiorna l'indicatore di forza
          if (isStrong) {
            strengthText.textContent = '‚úì Password Forte!';
            strengthIndicator.className = 'alert alert-success mb-0';
            submitBtn.disabled = false;
          } else {
            const satisfied = Object.values(requirements).filter(v => v).length;
            strengthText.textContent = `Requisiti soddisfatti: ${satisfied}/7 - La password deve avere almeno 10 caratteri con 3+ tipi di caratteri`;
            strengthIndicator.className = 'alert alert-warning mb-0';
            submitBtn.disabled = false;
          }
        })
        .catch(error => {
          console.error('Errore durante il controllo della password:', error);
        });
      }
      
      // Controlla la password mentre l'utente digita
      passwordInput.addEventListener('input', updatePasswordStrength);
      passwordInput.addEventListener('change', updatePasswordStrength);
      
      // Validazione al submit
      document.getElementById('passwordForm').addEventListener('submit', function(e) {
        const password = passwordInput.value;
        if (!password) {
          e.preventDefault();
          alert('Inserisci una password');
          return false;
        }
      });
    });
  </script>
{% endblock %}
