{% extends "base.html" %}

{% block title %}
{% if is_edit %}
Modifica Prenotazione - Sistema Prenotazioni
{% else %}
Nuova Prenotazione - Sistema Prenotazioni
{% endif %}
{% endblock %}

{% block content %}
<div class="card-simple mb-3">
    {% if is_edit %}
    <section role="region" aria-labelledby="page-title" class="mb-2">
        <h1 id="page-title" class="page-title">‚úèÔ∏è Modifica Prenotazione</h1>
    </section>
    <p class="page-subtitle">Modifica i dettagli della tua prenotazione</p>
    {% else %}
    <section role="region" aria-labelledby="page-title" class="mb-2">
        <h1 id="page-title" class="page-title">üìÖ Nuova Prenotazione</h1>
    </section>
    <p class="page-subtitle">Prenota una risorsa per le tue attivit√†</p>
    {% endif %}
</div>

<div class="card-simple">
    <form method="post" id="prenotazione-form">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_risorsa" class="form-label">Risorsa *</label>
                    {{ form.risorsa }}
                    {% if form.risorsa.errors %}
                    <div class="text-danger">
                        {{ form.risorsa.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="form-group">
                    <label for="id_quantita" class="form-label">Quantit√† *</label>
                    {{ form.quantita }}
                    {% if form.quantita.errors %}
                    <div class="text-danger">
                        {{ form.quantita.errors }}
                    </div>
                    {% endif %}
                    <small class="form-text text-muted">
                        Numero di postazioni/dispositivi richiesti
                    </small>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_data" class="form-label">Data *</label>
                    {{ form.data }}
                    {% if form.data.errors %}
                    <div class="text-danger">
                        {{ form.data.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_ora_inizio" class="form-label">Ora Inizio *</label>
                    {{ form.ora_inizio }}
                    {% if form.ora_inizio.errors %}
                    <div class="text-danger">
                        {{ form.ora_inizio.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="form-group">
                    <label for="id_ora_fine" class="form-label">Ora Fine *</label>
                    {{ form.ora_fine }}
                    {% if form.ora_fine.errors %}
                    <div class="text-danger">
                        {{ form.ora_fine.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <h5>üìã Informazioni Risorse Disponibili</h5>
            {% if risorse %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Risorsa</th>
                            <th>Tipo</th>
                            <th>Capacit√†</th>
                            <th>Dispositivi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for risorsa in risorse|slice:':5' %}
                        <tr>
                            <td>{{ risorsa.nome }}</td>
                            <td>
                                {% if risorsa.tipo == 'lab' %}
                                üè¢ Laboratorio
                                {% else %}
                                üì± Carrello
                                {% endif %}
                            </td>
                            <td>
                                {% if risorsa.capacita_massima %}
                                {{ risorsa.capacita_massima }} dispositivi
                                {% else %}
                                Spazio completo
                                {% endif %}
                            </td>
                            <td>
                                {% if risorsa.tipo == 'carrello' %}
                                {{ risorsa.get_dispositivi_riassunto }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nessuna risorsa disponibile. Contatta l'amministratore per la configurazione.
            </div>
            {% endif %}
        </div>
        
        <div class="form-actions" role="group" aria-label="Azioni modulo prenotazione">
            <button type="submit" class="btn btn-primary" aria-label="Invia prenotazione">
                {% if is_edit %}
                <i class="bi bi-check-circle"></i> Aggiorna Prenotazione
                {% else %}
                <i class="bi bi-plus-circle"></i> Crea Prenotazione
                {% endif %}
            </button>
            
            <a href="{% url 'prenotazioni:lista_prenotazioni' %}" class="btn btn-secondary" role="button" aria-label="Annulla e torna alla lista">
                <i class="bi bi-arrow-left" aria-hidden="true"></i> Annulla
            </a>
        </div>
    </form>
</div>

<div class="content-card">
    <h5>üìã Note Importanti</h5>
    <ul>
        <li>Le prenotazioni devono essere effettuate almeno 2 giorni prima</li>
        <li>Orari consentiti: 08:00 - 18:00</li>
        <li>Durata minima: 30 minuti, massima: 3 ore</li>
        <li>I laboratori si prenotano per l'intero spazio (quantit√† = 1)</li>
        <li>I carrelli permettono prenotazioni parziali di dispositivi</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calcola durata quando cambiano gli orari
    const oraInizio = document.getElementById('id_ora_inizio');
    const oraFine = document.getElementById('id_ora_fine');
    
    function calcolaDurata() {
        if (oraInizio && oraFine && oraInizio.value && oraFine.value) {
            const inizio = new Date(`1970-01-01T${oraInizio.value}:00`);
            const fine = new Date(`1970-01-01T${oraFine.value}:00`);
            
            if (fine > inizio) {
                const diffMs = fine - inizio;
                const diffMin = Math.round(diffMs / 60000);
                const ore = Math.floor(diffMin / 60);
                const min = diffMin % 60;
                
                // Mostra durata se c'√® un elemento apposito
                const durataElement = document.getElementById('durata-calcolata');
                if (durataElement) {
                    durataElement.textContent = `${ore}h ${min}m`;
                }
            }
        }
    }
    
    if (oraInizio) oraInizio.addEventListener('change', calcolaDurata);
    if (oraFine) oraFine.addEventListener('change', calcolaDurata);
    
    // Validazione client-side
    const form = document.getElementById('prenotazione-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const oraInizio = document.getElementById('id_ora_inizio').value;
            const oraFine = document.getElementById('id_ora_fine').value;
            const data = document.getElementById('id_data').value;
            
            if (!oraInizio || !oraFine || !data) {
                e.preventDefault();
                alert('Compila tutti i campi obbligatori');
                return false;
            }
            
            // Validazione orari
            if (oraInizio >= oraFine) {
                e.preventDefault();
                alert('L\\'ora di fine deve essere successiva all\\'ora di inizio');
                return false;
            }
            
            // Validazione orario consentito
            if (oraInizio < '08:00' || oraFine > '18:00') {
                e.preventDefault();
                alert('Le prenotazioni sono consentite solo tra le 08:00 e le 18:00');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
