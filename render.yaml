services:
  # Servizio web con Dockerfile
  - type: web
    name: prenotazioni-scuola
    dockerfilePath: Dockerfile
    buildCommand: |
      python manage.py makemigrations --noinput || echo "Migrazioni esistenti"
      python manage.py migrate --noinput || echo "Migrazione fallita"
      python manage.py collectstatic --noinput || echo "Static files falliti"
      python manage.py initialize_data --force || echo "Inizializzazione fallita"
    startCommand: gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: DJANGO_DEBUG
        value: false
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: ALLOWED_HOSTS
        value: reserveliceofollonica.onrender.com
      - key: DATABASE_URL
        generateValue: true
      - key: REDIS_URL
        generateValue: true
      - key: ADMIN_USERNAME
        generateValue: true
      - key: ADMIN_EMAIL
        value: admin@reserveliceofollonica.onrender.com
      - key: ADMIN_FIRST_NAME
        value: Amministratore
      - key: ADMIN_LAST_NAME
        value: Sistema
      - key: ADMIN_PASSWORD
        generateValue: true
      - key: PYTHONUNBUFFERED
        value: 1
    # run migrations automatically on deploy
    releaseCommand: "python manage.py migrate --noinput"
